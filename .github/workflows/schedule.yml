name: Monitor LOE Schedule

on:
  schedule:
    - cron: '10,40 * * * *' # Запускати о :10 та :40 хвилинах кожної години
  workflow_dispatch: # Кнопка для ручного запуску

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Дозвіл на запис (щоб оновити state.json)

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Monitor Script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: node index.js

      - name: Commit state changes
        run: |
          git config --global user.name 'LOE Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          # Додаємо state.json ТА package-lock.json (якщо змінений кроком npm install)
          git add state.json package-lock.json || echo "No files to add"
          
          # Комітимо лише, якщо є зміни, які були додані (state.json або package-lock.json)
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update schedule state"
            git push
            echo "Changes committed and pushed."
          fi
