name: Monitor LOE Schedule

on:
  schedule:
    - cron: '*/30 * * * *' # Запускати кожні 30 хвилин
  workflow_dispatch: # Кнопка для ручного запуску

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Дозвіл на запис (щоб оновити state.json)

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run Monitor Script
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: node index.js

      - name: Commit state changes
        run: |
          git config --global user.name 'LOE Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          # Перевіряємо, чи є зміни в git статус
          git add state.json || echo "state.json not found, skipping add"
          
          # Якщо є що комітити - комітимо, якщо ні - виходимо без помилки
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update schedule state" && git push)
